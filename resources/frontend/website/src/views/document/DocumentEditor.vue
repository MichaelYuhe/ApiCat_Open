<template>
    <div class="ac-document is-edit" v-loading="isDocumentLoading" ref="docuemntContainer" @click="editorFocus">
        <input
            class="ac-document__title"
            type="text"
            maxlength="255"
            ref="title"
            v-model="document.title"
            @keydown.enter="intoEditor"
            placeholder="请输入文档标题"
        />

        <AcEditor ref="editor" v-if="document.content" :document="document.content" :options="editorOptions" @on-change="onDocumentChange" />
    </div>
</template>
<script lang="ts">
    import { defineComponent, defineAsyncComponent, inject, ref } from 'vue'
    import { ElMessage as $Message } from 'element-plus'
    import { updateDoc, getDocumentDetail, getUrlTipList, deleteUrlTip, renameDoc } from '@/api/document'
    import { getApiParamList, addApiParam, deleteApiParam } from '@/api/params'
    import { uploader } from '@/api/uploader'
    import { loadImage } from '@/api/upload'
    import { debounce, isEmpty } from 'lodash-es'
    import { hideLoading } from '@/hooks/useLoading'
    import { useRoute, useRouter } from 'vue-router'
    import { useProjectStore } from '@/stores/project'
    import emitter, {
        DOCUMENT_SAVE_DONE,
        DOCUMENT_SAVE_ING,
        DOCUMENT_SAVE_ERROR,
        DOCUMENT_SAVE_BTN_DONE,
        DOCUMENT_SAVE_BTN_ING,
        DOCUMENT_SAVE_BTN_ERROR,
    } from '@/common/emitter'
    import { storeToRefs } from 'pinia'
    import SimpleLoading from './components/SimpleLoading.vue'
    import LoadingError from './components/LoadingError.vue'
    import useIdPublicParam from '@/hooks/useIdPublicParam'

    export default defineComponent({
        components: {
            AcEditor: defineAsyncComponent({
                loader: () => import('@natosoft/editor'),
                loadingComponent: SimpleLoading,
                errorComponent: LoadingError,
                timeout: 10000,
            }),
        },

        setup() {
            const updateTreeNode: any = inject('updateTreeNode')
            const $route: any = useRoute()
            const $router: any = useRouter()
            const docuemntContainer = ref(null)
            const projectStore = useProjectStore()
            const { projectInfo } = storeToRefs(projectStore)
            const publicParams = useIdPublicParam()

            return {
                publicParams,
                projectInfo,
                docuemntContainer,
                project_id: projectInfo.value.id,
                node_id: parseInt($route.params.node_id as string, 10),
                route: $route,
                router: $router,
                updateTreeNode,
            }
        },

        data() {
            return {
                editorOptions: {
                    uploadImage: (file: any) => this.uploadImage(file),
                    getAllCommonParams: () => this.getAllCommonParams(),
                    addCommonParam: (param: any) => this.addCommonParam(param),
                    deleteCommonParam: (param: any) => this.deleteCommonParam(param),
                    getUrlList: () => this.getUrlList(),
                    deleteUrl: (id: any) => this.deleteUrl(id),
                    openNotification: () => this.openNotification(),
                },
                document: {} as any,
                isLoading: false,
                isDocumentLoading: false,
            }
        },

        watch: {
            '$route.params.node_id': {
                immediate: true,
                handler: function () {
                    this.getDocumentDetail()
                },
            },
            'document.title': function () {
                this.onDocumentChange()
            },
        },

        methods: {
            openNotification() {
                ;(this.$refs['notice'] as any).show()
            },

            intoEditor() {
                setTimeout(() => this.$refs.editor && (this.$refs['editor'] as any).editor.focus(), 200)
            },

            editorFocus(e?: any) {
                if (!e || e.target === this.docuemntContainer) {
                    setTimeout(() => this.$refs.editor && (this.$refs['editor'] as any).editor.focus(true), 200)
                }
            },

            uploadImage(file: any) {
                return new Promise((resolve, reject) => {
                    if (!file) {
                        $Message.error('请选择图片')
                        return reject('请选择图片')
                    }

                    if (file.size > 10 * 1024 * 1024) {
                        $Message.error('图片不能超过10MB')
                        return reject('图片不能超过10MB')
                    }

                    uploader()
                        .send(file)
                        .end((error: any, res: any) => {
                            if (!error) {
                                loadImage(res.data).then(({ src }) => resolve(src))
                                return
                            }
                            $Message.error(error || '上传失败，请重试！')
                            reject('上传失败，请重试！')
                        })
                })
            },

            getUrlList() {
                return getUrlTipList(this.project_id)
                    .then((res: any) => res.data)
                    .catch(() => {
                        //
                    })
            },

            deleteUrl(id: any) {
                return deleteUrlTip(this.project_id, id).then(() => {
                    $Message.success('常用URL删除成功')
                })
            },

            addCommonParam(param: any) {
                const newParam = { ...param, project_id: this.project_id }
                delete newParam.sub_params
                delete newParam._id
                return addApiParam(newParam).then((res) => {
                    $Message.success('常用参数添加成功')
                    return res.data
                })
            },

            deleteCommonParam(param: any) {
                return deleteApiParam(this.project_id, param.id).then((res) => {
                    $Message.success('常用参数删除成功')
                    return res.data
                })
            },

            getAllCommonParams() {
                return getApiParamList(this.project_id)
                    .then((res) => res.data)
                    .catch((e) => {
                        //
                    })
            },

            getDocumentDetail() {
                const node_id = parseInt(this.route.params.node_id as string, 10)

                if (isNaN(node_id)) {
                    hideLoading()
                    return
                }

                this.node_id = node_id
                this.isDocumentLoading = true
                const data = { project_id: this.publicParams.projectId, doc_id: this.node_id }
                getDocumentDetail(data)
                    .then((res) => {
                        res.data.project_id = this.project_id
                        res.data.doc_id = res.data.id
                        !res.data.url && (res.data.url = '')
                        res.data.content = JSON.parse(res.data.content || '{}')
                        this.document = res.data
                        this.autoFocus()
                    })
                    .catch((e) => {
                        // this.reactiveNode()
                    })
                    .finally(() => {
                        this.isDocumentLoading = false
                        hideLoading()
                    })
            },

            updateTreeNodeTitle(node: any) {
                node && this.updateTreeNode && this.updateTreeNode(node.doc_id, { title: node.title || '' })
            },

            onSaveBtnClick() {
                this.save()
            },

            save() {
                const doc = this.getDocumentContent()
                if (!doc) {
                    // emitter.emit(DOCUMENT_SAVE_BTN_DONE)
                    return
                }
                this.isLoading = true
                updateDoc(doc)
                    .then(() => emitter.emit(DOCUMENT_SAVE_BTN_DONE))
                    .catch(() => emitter.emit(DOCUMENT_SAVE_BTN_ERROR))
                    .finally(() => {
                        this.isLoading = false
                    })
            },

            getDocumentContent() {
                if (this.$refs['editor'] && (this.$refs['editor'] as any).editor) {
                    let content = (this.$refs['editor'] as any).editor.getJSON()
                    return { ...this.document, content: JSON.stringify(content) }
                }

                // 默认返回原数据
                return this.document
            },

            onDocumentChange: debounce(function (this: any) {
                if (this.isLoading) {
                    return
                }
                emitter.emit(DOCUMENT_SAVE_ING)
                const doc = this.getDocumentContent()
                doc &&
                    updateDoc(doc)
                        .then((res: any) => {
                            emitter.emit(DOCUMENT_SAVE_DONE)
                            this.updateTreeNodeTitle(res.data)
                        })
                        .catch(() => {
                            emitter.emit(DOCUMENT_SAVE_ERROR)
                        })
            }, 200),

            onDocumentTitleChange: debounce(function (this: any) {
                if (isEmpty(this.document.title)) {
                    return
                }
                renameDoc({ project_id: this.project_id, title: this.document.title, doc_id: this.node_id })
                this.updateTreeNodeTitle({ doc_id: this.node_id, title: this.document.title })
            }, 500),

            autoFocus() {
                if (this.route.query.isNew) {
                    this.$refs.title && (this.$refs.title as any).focus()
                }
            },
        },

        mounted() {
            emitter.on(DOCUMENT_SAVE_BTN_ING, this.onSaveBtnClick)
        },
    })
</script>
