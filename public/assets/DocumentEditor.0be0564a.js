var E=Object.defineProperty,F=Object.defineProperties;var N=Object.getOwnPropertyDescriptors;var m=Object.getOwnPropertySymbols;var T=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable;var l=(t,e,o)=>e in t?E(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o,s=(t,e)=>{for(var o in e||(e={}))T.call(e,o)&&l(t,o,e[o]);if(m)for(var o of m(e))$.call(e,o)&&l(t,o,e[o]);return t},u=(t,e)=>F(t,N(e));import{b as A,a3 as L,a4 as B,a5 as P,a6 as j,X as h,Y as v,a7 as p,a8 as O,Z as d,a9 as U,aa as y,ab as w,ac as I,a2 as M}from"./index.30cab735.js";import{E as i,v as b}from"./element-plus.071360b2.js";import{G as R,bz as S,p as V,bd as k,aZ as J,r as z,as as f,bh as G,R as _,f as K,h as Z,av as q,aw as W,W as X,T as Y,ac as H,o as D}from"./vendor.be35f7a8.js";import{a as Q,d as x,b as tt}from"./params.5bd71d6d.js";const et=R({components:{AcEditor:S(()=>M(()=>import("./editor.es.843a673d.js"),["assets/editor.es.843a673d.js","assets/vendor.be35f7a8.js","assets/sortable.esm.85cd8ec3.js","assets/element-plus.071360b2.js","assets/element-plus.7d952092.css"]))},setup(){const t=V("updateTreeNode"),e=k(),o=J();return{docuemntContainer:z(null),project_id:e.params.project_id,node_id:parseInt(e.params.node_id,10),$route:e,$router:o,updateTreeNode:t}},data(){return{editorOptions:{uploadImage:t=>this.uploadImage(t),getAllCommonParams:()=>this.getAllCommonParams(),addCommonParam:t=>this.addCommonParam(t),deleteCommonParam:t=>this.deleteCommonParam(t),getUrlList:()=>this.getUrlList(),deleteUrl:t=>this.deleteUrl(t),openNotification:()=>this.openNotification()},document:{},isLoading:!1,isDocumentLoading:!1}},watch:{"$route.params.node_id":{immediate:!0,handler:function(){this.getDocumentDetail()}},"document.title":function(){this.onDocumentChange()}},methods:{openNotification(){this.$refs.notice.show()},intoEditor(){setTimeout(()=>this.$refs.editor&&this.$refs.editor.editor.focus(),200)},editorFocus(t){(!t||t.target===this.docuemntContainer)&&setTimeout(()=>this.$refs.editor&&this.$refs.editor.editor.focus(!0),200)},uploadImage(t){return new Promise((e,o)=>{if(!t)return i.error("\u8BF7\u9009\u62E9\u56FE\u7247"),o("\u8BF7\u9009\u62E9\u56FE\u7247");if(t.size>10*1024*1024)return i.error("\u56FE\u7247\u4E0D\u80FD\u8D85\u8FC710MB"),o("\u56FE\u7247\u4E0D\u80FD\u8D85\u8FC710MB");L().send(t).end((n,r)=>{if(!n){B(r.data).then(({src:c})=>e(c));return}i.error(n||"\u4E0A\u4F20\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5\uFF01"),o("\u4E0A\u4F20\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5\uFF01")})})},getUrlList(){return P(this.project_id).then(t=>t.data).catch(()=>{})},deleteUrl(t){return j(this.project_id,t).then(()=>{i.success("\u5E38\u7528URL\u5220\u9664\u6210\u529F")})},addCommonParam(t){const e=u(s({},t),{project_id:this.project_id});return delete e.sub_params,delete e._id,Q(e).then(o=>(i.success("\u5E38\u7528\u53C2\u6570\u6DFB\u52A0\u6210\u529F"),o.data))},deleteCommonParam(t){return x(this.project_id,t.id).then(e=>(i.success("\u5E38\u7528\u53C2\u6570\u5220\u9664\u6210\u529F"),e.data))},getAllCommonParams(){return tt(this.project_id).then(t=>t.data).catch(t=>{})},getDocumentDetail(){const t=parseInt(this.$route.params.node_id,10);if(isNaN(t)){h();return}this.node_id=t,this.isDocumentLoading=!0,v(this.project_id,this.node_id).then(e=>{e.data.project_id=this.project_id,e.data.doc_id=e.data.id,!e.data.url&&(e.data.url=""),e.data.content=JSON.parse(e.data.content||"{}"),this.document=e.data,this.autoFocus()}).catch(e=>{}).finally(()=>{this.isDocumentLoading=!1,h()})},updateTreeNodeTitle(t){t&&this.updateTreeNode&&this.updateTreeNode(t.doc_id,{title:t.title||""})},onSaveBtnClick(){this.save()},save(){this.isLoading=!0,p(this.getDocumentContent()).then(t=>{i.success(t.message||"\u4FDD\u5B58\u6210\u529F"),this.updateTreeNodeTitle(t.data),this.$router.push({name:O,params:{project_id:this.project_id,node_id:this.node_id}})}).catch(t=>t).finally(()=>{this.isLoading=!1})},getDocumentContent(){if(this.$refs.editor&&this.$refs.editor.editor){let t=this.$refs.editor.editor.getJSON();return u(s({},this.document),{content:JSON.stringify(t)})}return this.document},onDocumentChange:f(function(){d.emit(U),p(this.getDocumentContent()).then(t=>{d.emit(y),this.updateTreeNodeTitle(t.data)}).catch(()=>{d.emit(w)})},500),onDocumentTitleChange:f(function(){G(this.document.title)||(I({project_id:this.project_id,title:this.document.title,doc_id:this.node_id}),this.updateTreeNodeTitle({doc_id:this.node_id,title:this.document.title}))},500),autoFocus(){this.$route.query.isNew&&this.$refs.title&&this.$refs.title.focus()}}});function ot(t,e,o,n,r,c){const g=H("AcEditor"),C=b;return _((D(),K("div",{class:"ac-document is-edit",ref:"docuemntContainer",onClick:e[2]||(e[2]=(...a)=>t.editorFocus&&t.editorFocus(...a))},[_(Z("input",{class:"ac-document__title",type:"text",maxlength:"255",ref:"title","onUpdate:modelValue":e[0]||(e[0]=a=>t.document.title=a),onKeydown:e[1]||(e[1]=q((...a)=>t.intoEditor&&t.intoEditor(...a),["enter"])),placeholder:"\u8BF7\u8F93\u5165\u6587\u6863\u6807\u9898"},null,544),[[W,t.document.title]]),t.document.content?(D(),X(g,{key:0,ref:"editor",document:t.document.content,options:t.editorOptions,onOnChange:t.onDocumentChange},null,8,["document","options","onOnChange"])):Y("",!0)])),[[C,t.isDocumentLoading]])}var dt=A(et,[["render",ot]]);export{dt as default};
